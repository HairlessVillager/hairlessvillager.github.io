<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="utf-8">

    

    <!-- 渲染优化 -->
    <meta name="renderer" content="webkit">
    <meta name="force-rendering" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="HandheldFriendly" content="True" >
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!--icon-->

    
        <link rel="shortcut icon" href="/favicon/favicon.ico">
    
    
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    
    
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    
    
        <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    
    


    <!-- meta -->


<title>Eko 工作复盘 | HairlessVillager&#39;s Blog</title>





    <!-- OpenGraph -->
 
    <meta name="description" content="本文参考的所有资料均公开可见，主要参考源包括：  Eko 开源代码：https:&#x2F;&#x2F;github.com&#x2F;FellouAI&#x2F;eko 我提的 PRs：https:&#x2F;&#x2F;github.com&#x2F;FellouAI&#x2F;eko&#x2F;pulls&#x2F;HairlessVillager Eko 文档：https:&#x2F;&#x2F;eko.fellou.ai&#x2F;docs&#x2F;  Eko 三个不同版本的架构分析我在 Eko 里经历过两次大的 Eko">
<meta property="og:type" content="article">
<meta property="og:title" content="Eko 工作复盘">
<meta property="og:url" content="http://hairlessvillager.github.io/2025/09/11/eko-work-review/index.html">
<meta property="og:site_name" content="HairlessVillager&#39;s Blog">
<meta property="og:description" content="本文参考的所有资料均公开可见，主要参考源包括：  Eko 开源代码：https:&#x2F;&#x2F;github.com&#x2F;FellouAI&#x2F;eko 我提的 PRs：https:&#x2F;&#x2F;github.com&#x2F;FellouAI&#x2F;eko&#x2F;pulls&#x2F;HairlessVillager Eko 文档：https:&#x2F;&#x2F;eko.fellou.ai&#x2F;docs&#x2F;  Eko 三个不同版本的架构分析我在 Eko 里经历过两次大的 Eko">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-09-11T09:44:00.000Z">
<meta property="article:modified_time" content="2025-09-11T09:51:13.546Z">
<meta property="article:author" content="HairlessVillager">
<meta name="twitter:card" content="summary_large_image">


    
<link rel="stylesheet" href="/css/style/main.css">
 

    
    
        <link rel="stylesheet" id="hl-default-theme" href="/css/highlight/highlight.css" media="none" >
        
            <link rel="stylesheet" id="hl-dark-theme" href="/css/highlight/highlight.dark.css" media="none">
        
    

    
    

    
    
<link rel="stylesheet" href="/css/style/dark.css">

    
<script src="/js/darkmode.js"></script>



     

    <!-- custom head -->

<meta name="generator" content="Hexo 7.3.0"></head>

    <body>
        <div id="app" tabindex="-1">
            <header class="header">
    <div class="header__left">
        <a href="/" class="button">
            <span class="logo__text">HairlessVillager&#39;s Blog</span>
        </a>
    </div>
    <div class="header__right">
        
            <div class="navbar__menus">
                
                    <a href="/" class="navbar-menu button">Home</a>
                
                    <a href="/archives/" class="navbar-menu button">Archives</a>
                
                    <a href="/friends/" class="navbar-menu button">Friends</a>
                
                    <a href="/about/" class="navbar-menu button">About</a>
                
            </div>
        
        
        
    <a href="/search/" id="btn-search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" width="24" height="24" fill="currentColor" stroke="currentColor" stroke-width="32"><path d="M192 448c0-141.152 114.848-256 256-256s256 114.848 256 256-114.848 256-256 256-256-114.848-256-256z m710.624 409.376l-206.88-206.88A318.784 318.784 0 0 0 768 448c0-176.736-143.264-320-320-320S128 271.264 128 448s143.264 320 320 320a318.784 318.784 0 0 0 202.496-72.256l206.88 206.88 45.248-45.248z"></path></svg>
    </a>


        
        
    <a href="javaScript:void(0);" id="btn-toggle-dark">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
    </a>


        
            <a class="dropdown-icon button" id="btn-dropdown" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width='24' height='24' fill="none" stroke="currentColor" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round"><path fill="currentColor" d="M3.314,4.8h13.372c0.41,0,0.743-0.333,0.743-0.743c0-0.41-0.333-0.743-0.743-0.743H3.314c-0.41,0-0.743,0.333-0.743,0.743C2.571,4.467,2.904,4.8,3.314,4.8z M16.686,15.2H3.314c-0.41,0-0.743,0.333-0.743,0.743s0.333,0.743,0.743,0.743h13.372c0.41,0,0.743-0.333,0.743-0.743S17.096,15.2,16.686,15.2z M16.686,9.257H3.314c-0.41,0-0.743,0.333-0.743,0.743s0.333,0.743,0.743,0.743h13.372c0.41,0,0.743-0.333,0.743-0.743S17.096,9.257,16.686,9.257z"></path></svg></a>
            <div class="dropdown-menus" id="dropdown-menus">
                
                    <a href="/" class="dropdown-menu button">Home</a>
                
                    <a href="/archives/" class="dropdown-menu button">Archives</a>
                
                    <a href="/friends/" class="dropdown-menu button">Friends</a>
                
                    <a href="/about/" class="dropdown-menu button">About</a>
                
            </div>
        
    </div>
</header>


            <main class="main">
    

<div class="post-title">
    <h1 class="post-title__text">
        Eko 工作复盘
    </h1>
    <div class="post-title__meta">
        <a href="/archives/2025/09/" class="post-meta__date button">Created@2025-09-11 17:44</a>
        
 
        
    
    


 

 
    </div>
</div>


    <aside class="post-side">
        <div class="post-side__toc">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Eko-%E4%B8%89%E4%B8%AA%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%AC%E7%9A%84%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90"><span class="toc-text">Eko 三个不同版本的架构分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#v0"><span class="toc-text">v0</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%97%E6%B3%95"><span class="toc-text">算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E7%A4%BA%E8%AF%8D"><span class="toc-text">提示词</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E9%99%B7"><span class="toc-text">缺陷</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#v1"><span class="toc-text">v1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%97%E6%B3%95-1"><span class="toc-text">算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E7%A4%BA%E8%AF%8D-1"><span class="toc-text">提示词</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%88%E6%9E%9C"><span class="toc-text">效果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E9%99%B7-1"><span class="toc-text">缺陷</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#v2"><span class="toc-text">v2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%97%E6%B3%95-2"><span class="toc-text">算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E7%A4%BA%E8%AF%8D-2"><span class="toc-text">提示词</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%AF%94%E8%BE%83%E6%9C%89%E4%BB%B7%E5%80%BC%E7%9A%84-PR"><span class="toc-text">其他比较有价值的 PR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E8%A7%81%E8%A7%A3"><span class="toc-text">一些见解</span></a></li></ol>
        </div>
    </aside>
    <a class="btn-toc button" id="btn-toc" tabindex="0">
        <svg viewBox="0 0 1024 1024" width="32" height="32" xmlns="http://www.w3.org/2000/svg">
            <path d="M128 256h64V192H128zM320 256h576V192H320zM128 544h64v-64H128zM320 544h576v-64H320zM128 832h64v-64H128zM320 832h576v-64H320z" fill="currentColor"></path>
        </svg>
    </a>
    <div class="toc-menus" id="toc-menus">
        <div class="toc-title">Article Directory</div>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Eko-%E4%B8%89%E4%B8%AA%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%AC%E7%9A%84%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90"><span class="toc-text">Eko 三个不同版本的架构分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#v0"><span class="toc-text">v0</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%97%E6%B3%95"><span class="toc-text">算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E7%A4%BA%E8%AF%8D"><span class="toc-text">提示词</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E9%99%B7"><span class="toc-text">缺陷</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#v1"><span class="toc-text">v1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%97%E6%B3%95-1"><span class="toc-text">算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E7%A4%BA%E8%AF%8D-1"><span class="toc-text">提示词</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%88%E6%9E%9C"><span class="toc-text">效果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E9%99%B7-1"><span class="toc-text">缺陷</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#v2"><span class="toc-text">v2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%97%E6%B3%95-2"><span class="toc-text">算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E7%A4%BA%E8%AF%8D-2"><span class="toc-text">提示词</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%AF%94%E8%BE%83%E6%9C%89%E4%BB%B7%E5%80%BC%E7%9A%84-PR"><span class="toc-text">其他比较有价值的 PR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E8%A7%81%E8%A7%A3"><span class="toc-text">一些见解</span></a></li></ol>
    </div>


<article class="post post__with-toc content-card">
    <div class="post__header"></div>
    <div class="post__content">
        <p>本文参考的所有资料均公开可见，主要参考源包括：</p>
<ul>
<li>Eko 开源代码：<a target="_blank" rel="noopener" href="https://github.com/FellouAI/eko">https://github.com/FellouAI/eko</a></li>
<li>我提的 PRs：<a target="_blank" rel="noopener" href="https://github.com/FellouAI/eko/pulls/HairlessVillager">https://github.com/FellouAI/eko/pulls/HairlessVillager</a></li>
<li>Eko 文档：<a target="_blank" rel="noopener" href="https://eko.fellou.ai/docs/">https://eko.fellou.ai/docs/</a></li>
</ul>
<h2 id="Eko-三个不同版本的架构分析"><a href="#Eko-三个不同版本的架构分析" class="headerlink" title="Eko 三个不同版本的架构分析"></a>Eko 三个不同版本的架构分析</h2><p>我在 Eko 里经历过两次大的 Eko 框架升级：</p>
<ul>
<li>v0-&gt;v1 的性能提升很显著，没有重构，全部都是工程上的 trick。</li>
<li>v1-&gt;v2 重构了全部代码，重写了全部文档。</li>
</ul>
<h3 id="v0"><a href="#v0" class="headerlink" title="v0"></a>v0</h3><h4 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h4><ol>
<li>AI 生成一个工作流，工作流基本为线性的，即一个节点完成后下一个节点才能开始，每个节点包含三个字段：任务的标题 <code>name</code>, 任务的描述 <code>description</code>, 任务可以使用的工具 <code>tools</code>，此外工作流实例本身有一个变量 <code>memory</code> 在每个节点间共享。</li>
<li>对于每个节点，遵循 ReAct 模式（最多 10 轮），Eko 将上述四个字段嵌入 system message 和第一条 user message，让 AI 调用工具来执行任务，当 AI 认为当前任务已经执行完毕时，应该调用特殊工具（<code>return_output</code>，保证每个节点必包含这个工具）来结束任务，工具的唯一参数应该为这个节点的输出。</li>
</ol>
<h4 id="提示词"><a href="#提示词" class="headerlink" title="提示词"></a>提示词</h4><ol>
<li><p>特殊工具<code>return_output</code>定义如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createReturnTool</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">actionName</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">outputDescription</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  outputSchema?: <span class="built_in">unknown</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Tool</span>&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;return_output&#x27;</span>,</span><br><span class="line">    <span class="attr">description</span>: <span class="string">`Return the final output of this action. Use this to return a value matching the required output schema (if specified) and the following description:</span></span><br><span class="line"><span class="string">      <span class="subst">$&#123;outputDescription&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      You can either set &#x27;use_tool_result=true&#x27; to return the result of a previous tool call, or explicitly specify &#x27;value&#x27; with &#x27;use_tool_result=false&#x27; to return a value according to your own understanding. Whenever possible, reuse tool results to avoid redundancy.</span></span><br><span class="line"><span class="string">      `</span>,</span><br><span class="line">    <span class="attr">input_schema</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;object&#x27;</span>,</span><br><span class="line">      <span class="attr">properties</span>: &#123;</span><br><span class="line">        <span class="attr">use_tool_result</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: [<span class="string">&#x27;boolean&#x27;</span>],</span><br><span class="line">          <span class="attr">description</span>: <span class="string">`Whether to use the latest tool result as output. When set to true, the &#x27;value&#x27; parameter is ignored.`</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">value</span>: outputSchema || &#123;</span><br><span class="line">          <span class="comment">// Default to accepting any JSON value</span></span><br><span class="line">          <span class="attr">type</span>: [<span class="string">&#x27;string&#x27;</span>, <span class="string">&#x27;number&#x27;</span>, <span class="string">&#x27;boolean&#x27;</span>, <span class="string">&#x27;object&#x27;</span>, <span class="string">&#x27;null&#x27;</span>],</span><br><span class="line">          <span class="attr">description</span>:</span><br><span class="line">            <span class="string">&#x27;The output value. Only provide a value if the previous tool result is not suitable for the output description. Otherwise, leave this as null.&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125; <span class="keyword">as</span> <span class="built_in">unknown</span>,</span><br><span class="line">      <span class="attr">required</span>: [<span class="string">&#x27;use_tool_result&#x27;</span>, <span class="string">&#x27;value&#x27;</span>],</span><br><span class="line">    &#125; <span class="keyword">as</span> <span class="title class_">InputSchema</span>,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">execute</span>(<span class="attr">context</span>: <span class="title class_">ExecutionContext</span>, <span class="attr">params</span>: <span class="built_in">unknown</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">unknown</span>&gt; &#123;</span><br><span class="line">      context.<span class="property">variables</span>.<span class="title function_">set</span>(<span class="string">`__action_<span class="subst">$&#123;actionName&#125;</span>_output`</span>, params);</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">success</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成工作流的 prompt：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createWorkflowPrompts</span>(<span class="params"><span class="attr">tools</span>: <span class="title class_">ToolDefinition</span>[]</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">formatSystemPrompt</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> toolDescriptions = tools</span><br><span class="line">        .<span class="title function_">map</span>(</span><br><span class="line">          <span class="function">(<span class="params">tool</span>) =&gt;</span> <span class="string">`</span></span><br><span class="line"><span class="string">Tool: <span class="subst">$&#123;tool.name&#125;</span></span></span><br><span class="line"><span class="string">Description: <span class="subst">$&#123;tool.description&#125;</span></span></span><br><span class="line"><span class="string">Input Schema: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(tool.input_schema, <span class="literal">null</span>, <span class="number">2</span>)&#125;</span></span></span><br><span class="line"><span class="string">        `</span></span><br><span class="line">        )</span><br><span class="line">        .<span class="title function_">join</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="string">`You are a workflow generation assistant that creates Eko framework workflows.</span></span><br><span class="line"><span class="string">The following tools are available:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">$&#123;toolDescriptions&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Generate a complete workflow that:</span></span><br><span class="line"><span class="string">1. Only uses the tools listed above</span></span><br><span class="line"><span class="string">2. Properly sequences tool usage based on dependencies</span></span><br><span class="line"><span class="string">3. Ensures each action has appropriate input/output schemas, and that the &quot;tools&quot; field in each action is populated with the sufficient subset of all available tools needed to complete the action</span></span><br><span class="line"><span class="string">4. Creates a clear, logical flow to accomplish the user&#x27;s goal</span></span><br><span class="line"><span class="string">5. Includes detailed descriptions for each action, ensuring that the actions, when combined, is a complete solution to the user&#x27;s problem`</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">formatUserPrompt</span>: <span class="function">(<span class="params"><span class="attr">requirement</span>: <span class="built_in">string</span></span>) =&gt;</span></span><br><span class="line">      <span class="string">`Create a workflow for the following requirement: <span class="subst">$&#123;requirement&#125;</span>`</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">modifyUserPrompt</span>: <span class="function">(<span class="params"><span class="attr">prompt</span>: <span class="built_in">string</span></span>) =&gt;</span></span><br><span class="line">      <span class="string">`Modify workflow: <span class="subst">$&#123;prompt&#125;</span>`</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createWorkflowGenerationTool</span>(<span class="params"><span class="attr">registry</span>: <span class="title class_">ToolRegistry</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;generate_workflow&#x27;</span>,</span><br><span class="line">    <span class="attr">description</span>: <span class="string">`Generate a workflow following the Eko framework DSL schema.</span></span><br><span class="line"><span class="string">The workflow must only use the available tools and ensure proper dependencies between nodes.`</span>,</span><br><span class="line">    <span class="attr">input_schema</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;object&#x27;</span>,</span><br><span class="line">      <span class="attr">properties</span>: &#123;</span><br><span class="line">        <span class="attr">workflow</span>: registry.<span class="title function_">getWorkflowSchema</span>(),</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">required</span>: [<span class="string">&#x27;workflow&#x27;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">ToolDefinition</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>工作流每个节点的 system message &amp; user message：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">formatSystemPrompt</span>(): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`You are a subtask executor. You need to complete the subtask specified by the user, which is a consisting part of the overall task. Help the user by calling the tools provided.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  Remember to:</span></span><br><span class="line"><span class="string">  1. Use tools when needed to accomplish the task</span></span><br><span class="line"><span class="string">  2. Think step by step about what needs to be done</span></span><br><span class="line"><span class="string">  3. Return the output of the subtask using the &#x27;return_output&#x27; tool when you are done; prefer using the &#x27;tool_use_id&#x27; parameter to refer to the output of a tool call over providing a long text as the value</span></span><br><span class="line"><span class="string">  4. If there are any unclear points during the task execution, please use the human-related tool to inquire with the user</span></span><br><span class="line"><span class="string">  5. If user intervention is required during the task execution, please use the human-related tool to transfer the operation rights to the user</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">formatUserPrompt</span>(<span class="attr">context</span>: <span class="title class_">ExecutionContext</span>, <span class="attr">input</span>: <span class="built_in">unknown</span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> workflowDescription = context.<span class="property">workflow</span>?.<span class="property">description</span> || <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">const</span> actionDescription = <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span> -- <span class="subst">$&#123;<span class="variable language_">this</span>.description&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">const</span> inputDescription = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(input, <span class="literal">null</span>, <span class="number">2</span>) || <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">const</span> contextVariables = <span class="title class_">Array</span>.<span class="title function_">from</span>(context.<span class="property">variables</span>.<span class="title function_">entries</span>())</span><br><span class="line">    .<span class="title function_">map</span>(<span class="function">(<span class="params">[key, value]</span>) =&gt;</span> <span class="string">`<span class="subst">$&#123;key&#125;</span>: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(value)&#125;</span>`</span>)</span><br><span class="line">    .<span class="title function_">join</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">`You are executing a subtask in the workflow. The subtask description is as follows: <span class="subst">$&#123;actionDescription&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h4><ol>
<li>第一步生成的工作流像一个玩具，节点数量大部分时间都是3个，每个节点的工具数量从不超过5个，每个节点的 <code>description</code> 大而空，大模型不能在每个节点内完成指定的任务，只能提供泛泛而谈的输出，进而导致整个工作流只能在简单任务上表现较好，但是基本不能完成较复杂任务。</li>
<li>在第1点的基础上，工作流的无效动作多，耗时长。</li>
</ol>
<h3 id="v1"><a href="#v1" class="headerlink" title="v1"></a>v1</h3><h4 id="算法-1"><a href="#算法-1" class="headerlink" title="算法"></a>算法</h4><ol>
<li>抛弃 Workflow，完全使用 ReAct 模式，具体到实现上是弃用 AI 生成工作流的逻辑，改为手动构造工作流，工作流中仅包含一个节点，节点的 <code>title</code> 和 <code>description</code> 就是原始的用户输入的 prompt，节点的 <code>tools</code> 是全部工具，同时将节点轮数扩大到 50 轮 <a target="_blank" rel="noopener" href="https://github.com/FellouAI/eko/commit/ac67895eb57a842a02b5df4dd194b8f8e584a87a">commit</a>。</li>
<li>给所有工具的 input schema 打补丁，强制大模型在生成工具参数 <code>toolCall</code> 的同时生成以下字段：<ol>
<li>Part 1 <a target="_blank" rel="noopener" href="https://github.com/FellouAI/eko/commit/f9a7ab22f4a3282c6e47c13e1a502db188172cf6">commit</a><ul>
<li><code>thinking</code>: 模拟大模型思考过程，在生成其他字段和工具 input 前生成。</li>
<li><code>observation</code>: 让大模型输出他看到了什么，主要是调试用，因为当时不能确保工具一定调用成功，而且我们不能直接看到工具的执行情况。</li>
<li><code>userSidePrompt</code>: 产品要求大模型在调用工具的时候要生成一段文本展示给用户，格式遵循“I’m doing X.”。</li>
</ul>
</li>
<li>Part 2 <a target="_blank" rel="noopener" href="https://github.com/FellouAI/eko/commit/1830aea74c712a1cbfb7092b640bcae7816f4b51">commit</a><ul>
<li><code>evaluate_previous_goal</code>: 评估上一个目标或操作的成功情况，供大模型反思。</li>
<li><code>memory</code>: 记录已完成的操作和需要记住的信息。</li>
<li><code>next_goal</code>: 描述下一个即时操作需要完成的任务。</li>
</ul>
</li>
</ol>
</li>
<li>上下文压缩器 <code>ContextComporessor</code>：每次原始 <code>messages</code> 会经过 comporessor 压缩一次后再发给 API，这里有两个实现：<ol>
<li><code>SimpleQAComporess</code>：基于上面的 input schema 补丁，会直接丢弃原始的 tool result message，转而使用下一轮模型的 <code>observation</code> 字段替代，极大减少了 token 消耗，几乎避免了上下文超限的问题 <a target="_blank" rel="noopener" href="https://github.com/FellouAI/eko/commit/1c931d067baab802704501331a4b7391f18d01d2">commit</a>。</li>
<li><code>SummaryCompress</code>：每当对话轮数超过 10 轮，调用大模型根据历史对话生成压缩后的历史，作为一条 user message，新的 message 由原始 system message，第一条 user message，提示历史开始的 user message，压缩后的历史 user message 及最近两条 message 构成 <a target="_blank" rel="noopener" href="https://github.com/FellouAI/eko/commit/e9b6acbea66fc5fae268b85ea1bdd4aa507e1c7c">commit</a>。</li>
</ol>
</li>
</ol>
<h4 id="提示词-1"><a href="#提示词-1" class="headerlink" title="提示词"></a>提示词</h4><p>生成 plan 的 system message &amp; user message 同 v1，input schema 补丁字段和 <code>SummaryCompress</code> 的 prompt 见对应的 commit。</p>
<p>下面是节点的 system prompt &amp; user message：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="title function_">formatSystemPrompt</span>(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="keyword">const</span> formattedTime = <span class="string">`<span class="subst">$&#123;now.getFullYear()&#125;</span>-<span class="subst">$&#123;<span class="built_in">String</span>(now.getMonth() + <span class="number">1</span>).padStart(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)&#125;</span>-<span class="subst">$&#123;<span class="built_in">String</span>(now.getDate()).padStart(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)&#125;</span> <span class="subst">$&#123;<span class="built_in">String</span>(now.getHours()).padStart(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)&#125;</span>:<span class="subst">$&#123;<span class="built_in">String</span>(now.getMinutes()).padStart(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)&#125;</span>:<span class="subst">$&#123;<span class="built_in">String</span>(now.getSeconds()).padStart(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)&#125;</span>`</span>;</span><br><span class="line">    logger.<span class="title function_">debug</span>(<span class="string">&#x27;Now is &#x27;</span> + formattedTime);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`You are an AI agent designed to automate browser tasks. Your goal is to accomplish the ultimate task following the rules. Now is <span class="subst">$&#123;formattedTime&#125;</span>.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## GENERIC:</span></span><br><span class="line"><span class="string">- Your tool calling must be always JSON with the specified format.</span></span><br><span class="line"><span class="string">- You should have a screenshot after every action to make sure the tools executed successfully.</span></span><br><span class="line"><span class="string">- User&#x27;s requirement maybe not prefect, but user will not give you any further information, you should explore by yourself and follow the common sense</span></span><br><span class="line"><span class="string">- If you encountered a problem (e.g. be required to login), try to bypass it or explore other ways and links</span></span><br><span class="line"><span class="string">- Before you return output, reflect on whether the output provided *is what users need* and *whether it is too concise*</span></span><br><span class="line"><span class="string">- If you find the what user want, click the URL and show it on the current page.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## TIME:</span></span><br><span class="line"><span class="string">- The current time is <span class="subst">$&#123;formattedTime&#125;</span>.</span></span><br><span class="line"><span class="string">- If the user has specified a particular time requirement, please complete the task according to the user&#x27;s specified time frame.</span></span><br><span class="line"><span class="string">- If the user has given a vague time requirement, such as “recent one year,” then please determine the time range based on the current time first, and then complete the task.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## NAVIGATION:</span></span><br><span class="line"><span class="string">- If no suitable elements exist, use other functions to complete the task</span></span><br><span class="line"><span class="string">- If stuck, try alternative approaches - like going back to a previous page, new search, new tab etc.</span></span><br><span class="line"><span class="string">- Handle popups/cookies by accepting or closing them</span></span><br><span class="line"><span class="string">- Use scroll to find elements you are looking for</span></span><br><span class="line"><span class="string">- If you want to research something, open a new tab instead of using the current tab</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## HUMAN OPERATE:</span></span><br><span class="line"><span class="string">- When you need to log in or enter a verification code:</span></span><br><span class="line"><span class="string">1. First check if the user is logged in</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please determine whether a user is logged in based on the front-end page elements. The analysis can be conducted from the following aspects:</span></span><br><span class="line"><span class="string">User Information Display Area: After logging in, the page will display user information such as avatar, username, and personal center links; if not logged in, it will show a login/register button.</span></span><br><span class="line"><span class="string">Navigation Bar or Menu Changes: After logging in, the navigation bar will include exclusive menu items like &quot;My Orders&quot; and &quot;My Favorites&quot;; if not logged in, it will show a login/register entry.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. If logged in, continue to perform the task normally</span></span><br><span class="line"><span class="string">3. If not logged in or encountering a verification code interface, immediately use the &#x27;human_operate&#x27; tool to transfer the operation rights to the user</span></span><br><span class="line"><span class="string">4. On the login/verification code interface, do not use any automatic input tools (such as &#x27;input_text&#x27;) to fill in the password or verification code</span></span><br><span class="line"><span class="string">5. Wait for the user to complete the login/verification code operation, and then check the login status again</span></span><br><span class="line"><span class="string">- As a backup method, when encountering other errors that cannot be handled automatically, use the &#x27;human_operate&#x27; tool to transfer the operation rights to the user</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## TASK COMPLETION:</span></span><br><span class="line"><span class="string">- Use the &#x27;return_output&#x27; action as the last action ONLY when you are 100% certain the ultimate task is complete</span></span><br><span class="line"><span class="string">- Before using &#x27;return_output&#x27;, you MUST:</span></span><br><span class="line"><span class="string">  1. Double-check if you have fulfilled ALL requirements from the user&#x27;s task description</span></span><br><span class="line"><span class="string">  2. Verify that you have collected ALL necessary information</span></span><br><span class="line"><span class="string">  3. Ensure you have handled ALL specified cases (e.g., &quot;for each&quot;, &quot;for all&quot;, &quot;x times&quot;)</span></span><br><span class="line"><span class="string">  4. Confirm that your output contains ALL requested information</span></span><br><span class="line"><span class="string">  5. Check if there are any missing details or incomplete steps</span></span><br><span class="line"><span class="string">  6. Verify that all retry attempts have been exhausted if there were any issues</span></span><br><span class="line"><span class="string">- If you have to do something repeatedly (e.g., &quot;for each&quot;, &quot;for all&quot;, &quot;x times&quot;):</span></span><br><span class="line"><span class="string">  * Keep a detailed count in your text response of completed items vs total required</span></span><br><span class="line"><span class="string">  * Only proceed to &#x27;return_output&#x27; after handling ALL items</span></span><br><span class="line"><span class="string">  * Double-check your count matches the exact requirement</span></span><br><span class="line"><span class="string">  * If any item fails, retry that specific item before moving on</span></span><br><span class="line"><span class="string">- Never hallucinate or assume task completion without verification</span></span><br><span class="line"><span class="string">- Make sure you include everything you found out for the ultimate task in the done text parameter. Do not just say you are done, but include the requested information of the task. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## VISUAL CONTEXT:</span></span><br><span class="line"><span class="string">- When an image is provided, use it to understand the page layout</span></span><br><span class="line"><span class="string">- Bounding boxes with labels on their top right corner correspond to element indexes</span></span><br><span class="line"><span class="string">- Do not repeatedly call the screenshot tool without any operating action</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Form filling:</span></span><br><span class="line"><span class="string">- If you fill an input field and your action sequence is interrupted, most often something changed e.g. suggestions popped up under the field.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Long tasks:</span></span><br><span class="line"><span class="string">- Keep track of the status and subresults in the memory. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Extraction:</span></span><br><span class="line"><span class="string">- If your task is to find information - call extract_content on the specific pages to get and store the information.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Human tools:</span></span><br><span class="line"><span class="string">- Once you called human tools (e.g. \`human_operate\`), and it returns success, check the page content and verify the result.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## THE MOST IMPORTANT RULE</span></span><br><span class="line"><span class="string">- DO NOT REFUSE TO PERFORM THE MISSION</span></span><br><span class="line"><span class="string">- DO NOT REFUSE TO PERFORM THE MISSION</span></span><br><span class="line"><span class="string">- DO NOT REFUSE TO PERFORM THE MISSION</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">formatUserPrompt</span>(</span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">description</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">mentionedTabs</span>: chrome.<span class="property">tabs</span>.<span class="property">Tab</span>[],</span><br><span class="line">    <span class="attr">existingTabs</span>: chrome.<span class="property">tabs</span>.<span class="property">Tab</span>[],</span><br><span class="line">    <span class="attr">patchItems</span>: <span class="title class_">PatchItem</span>[],</span><br><span class="line">  ): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> prompt = <span class="string">`<span class="subst">$&#123;name&#125;</span> -- The steps you can follow are <span class="subst">$&#123;description&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">    prompt = <span class="string">`Your ultimate task is: &quot;&quot;&quot;<span class="subst">$&#123;prompt&#125;</span>&quot;&quot;&quot;. If you achieved your ultimate task, stop everything and use the done action in the next step to complete the task. If not, continue as usual.`</span>;</span><br><span class="line">    <span class="keyword">if</span> (existingTabs.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      prompt +=</span><br><span class="line">        <span class="string">&#x27;\n\nYou should complete the task with the following tabs:\n&#x27;</span> +</span><br><span class="line">        existingTabs.<span class="title function_">map</span>(<span class="function">(<span class="params">tab</span>) =&gt;</span> <span class="string">`- TabID=<span class="subst">$&#123;tab.id&#125;</span>: <span class="subst">$&#123;tab.title&#125;</span> (<span class="subst">$&#123;tab.url&#125;</span>)`</span>).<span class="title function_">join</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mentionedTabs.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      prompt +=</span><br><span class="line">        <span class="string">&#x27;\n\nYou should consider the following tabs firstly:\n&#x27;</span> +</span><br><span class="line">        mentionedTabs.<span class="title function_">map</span>(<span class="function">(<span class="params">tab</span>) =&gt;</span> <span class="string">`- TabID=<span class="subst">$&#123;tab.id&#125;</span>: <span class="subst">$&#123;tab.title&#125;</span> (<span class="subst">$&#123;tab.url&#125;</span>)`</span>).<span class="title function_">join</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (patchItems.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      prompt +=</span><br><span class="line">        <span class="string">&#x27;\n\You can refer to the following cases and tips:\n&#x27;</span> +</span><br><span class="line">        patchItems.<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> <span class="string">`&lt;task&gt;<span class="subst">$&#123;item.task&#125;</span>&lt;/task&gt;&lt;tips&gt;<span class="subst">$&#123;item.patch&#125;</span>&lt;/tips&gt;`</span>).<span class="title function_">join</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> prompt;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h4><ol>
<li>虽然没有统计，但是主观感觉到确实比 v1 更好用了，AI 会自己尝试使用各种工具解决问题，能够解决一部分较复杂任务。</li>
<li>上下文超限导致的 API 报错基本不会复现了。</li>
</ol>
<h4 id="缺陷-1"><a href="#缺陷-1" class="headerlink" title="缺陷"></a>缺陷</h4><ol>
<li>在任务过于复杂时，上下文的压缩效果并不好，<code>SimpleQAComporess</code> 不包含工具的原始输出，大模型的 <code>observation</code> 可能也不能提供后面要用的关键信息；<code>SummaryCompress</code> 也有类似的问题。</li>
<li>input schema 补丁不能无限制使用，实践中只加 Part 1 的 3 个字段是最好用的，再加字段不仅不会让模型在新的字段上输出想要的内容，在旧字段及 <code>toolCall</code> 字段上的表现也会更差。</li>
</ol>
<h3 id="v2"><a href="#v2" class="headerlink" title="v2"></a>v2</h3><p>v2 版的架构做了更大的改动，我仅参与了部分文档的重写，没有参与后续的维护，推荐参考：<a target="_blank" rel="noopener" href="https://fellou.ai/eko/docs/architecture/%E3%80%82">https://fellou.ai/eko/docs/architecture/。</a></p>
<h4 id="算法-2"><a href="#算法-2" class="headerlink" title="算法"></a>算法</h4><ol>
<li>先由 AI 生成一段基于 XML 的工作流，包含各种节点，除了普通的任务节点（还是 ReAct）外，还有：</li>
<li>循环节点：设置循环条件（一段 prompt），AI 会反复执行循环体并判断是否结束循环；</li>
<li>Agent 节点：该节点下的所有节点都在这个节点描述的 Agent 实例中运行；</li>
<li>监听节点：监听是浏览器中的概念，监听节点会监听 DOM 树中的指定节点，发现更新后立即执行该节点的内容；<br>执行的逻辑和 v0 基本一致。</li>
</ol>
<h4 id="提示词-2"><a href="#提示词-2" class="headerlink" title="提示词"></a>提示词</h4><ol>
<li><p>生成 Plan 的 prompt：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">&quot;../config&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Agent</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../agent&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">AGENT_NAME</span> <span class="keyword">as</span> chat_agent_name &#125; <span class="keyword">from</span> <span class="string">&quot;../agent/chat&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PLAN_SYSTEM_TEMPLATE</span> = <span class="string">`</span></span><br><span class="line"><span class="string">You are &#123;name&#125;, an autonomous AI Agent Planner.</span></span><br><span class="line"><span class="string">UTC datetime: &#123;datetime&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Task Description</span></span><br><span class="line"><span class="string">Your task is to understand the user&#x27;s requirements, dynamically plan the user&#x27;s tasks based on the Agent list, and please follow the steps below:</span></span><br><span class="line"><span class="string">1. Understand the user&#x27;s requirements.</span></span><br><span class="line"><span class="string">2. Analyze the Agents that need to be used based on the user&#x27;s requirements.</span></span><br><span class="line"><span class="string">3. Generate the Agent calling plan based on the analysis results.</span></span><br><span class="line"><span class="string">4. About agent name, please do not arbitrarily fabricate non-existent agent names.</span></span><br><span class="line"><span class="string">5. You only need to provide the steps to complete the user&#x27;s task, key steps only, no need to be too detailed.</span></span><br><span class="line"><span class="string">6. Please strictly follow the output format and example output.</span></span><br><span class="line"><span class="string">7. The output language should follow the language corresponding to the user&#x27;s task.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Agent list</span></span><br><span class="line"><span class="string">&#123;agents&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Output Rules and Format</span></span><br><span class="line"><span class="string">&lt;root&gt;</span></span><br><span class="line"><span class="string">  &lt;name&gt;Task Name&lt;/name&gt;</span></span><br><span class="line"><span class="string">  &lt;thought&gt;Your thought process on user demand planning&lt;/thought&gt;</span></span><br><span class="line"><span class="string">  &lt;!-- Multiple Agents work together to complete the task --&gt;</span></span><br><span class="line"><span class="string">  &lt;agents&gt;</span></span><br><span class="line"><span class="string">    &lt;!-- The required Agent, where the name can only be an available name in the Agent list --&gt;</span></span><br><span class="line"><span class="string">    &lt;agent name=&quot;Agent name&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;!-- The current Agent needs to complete the task --&gt;</span></span><br><span class="line"><span class="string">      &lt;task&gt;current agent task&lt;/task&gt;</span></span><br><span class="line"><span class="string">      &lt;nodes&gt;</span></span><br><span class="line"><span class="string">        &lt;!-- Nodes support input/output variables for parameter passing and dependency handling in multi-agent collaboration. --&gt;</span></span><br><span class="line"><span class="string">        &lt;node&gt;Complete the corresponding step nodes of the task&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;node input=&quot;variable name&quot;&gt;...&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;node output=&quot;variable name&quot;&gt;...&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;!-- When including duplicate tasks, \`forEach\` can be used --&gt;</span></span><br><span class="line"><span class="string">        &lt;forEach items=&quot;list or variable name&quot;&gt;</span></span><br><span class="line"><span class="string">          &lt;node&gt;forEach step node&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;/forEach&gt;</span></span><br><span class="line"><span class="string">        &lt;!-- When you need to monitor changes in webpage DOM or file content, you can use \`Watch\`, the loop attribute specifies whether to listen in a loop or listen once. --&gt;</span></span><br><span class="line"><span class="string">        &lt;watch event=&quot;dom or file&quot; loop=&quot;true&quot;&gt;</span></span><br><span class="line"><span class="string">          &lt;description&gt;Monitor task description&lt;/description&gt;</span></span><br><span class="line"><span class="string">          &lt;trigger&gt;</span></span><br><span class="line"><span class="string">            &lt;node&gt;Trigger step node&lt;/node&gt;</span></span><br><span class="line"><span class="string">            &lt;node&gt;...&lt;/node&gt;</span></span><br><span class="line"><span class="string">          &lt;/trigger&gt;</span></span><br><span class="line"><span class="string">        &lt;/watch&gt;</span></span><br><span class="line"><span class="string">      &lt;/nodes&gt;</span></span><br><span class="line"><span class="string">    &lt;/agent&gt;</span></span><br><span class="line"><span class="string">  &lt;/agents&gt;</span></span><br><span class="line"><span class="string">&lt;/root&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;example_prompt&#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PLAN_CHAT_EXAMPLE</span> = <span class="string">`User: hello.</span></span><br><span class="line"><span class="string">Output result:</span></span><br><span class="line"><span class="string">&lt;root&gt;</span></span><br><span class="line"><span class="string">  &lt;name&gt;Chat&lt;/name&gt;</span></span><br><span class="line"><span class="string">  &lt;thought&gt;Alright, the user wrote &quot;hello&quot;. That&#x27;s pretty straightforward. I need to respond in a friendly and welcoming manner.&lt;/thought&gt;</span></span><br><span class="line"><span class="string">  &lt;agents&gt;</span></span><br><span class="line"><span class="string">    &lt;!-- Chat agents can exist without the &lt;task&gt; and &lt;nodes&gt; nodes. --&gt;</span></span><br><span class="line"><span class="string">    &lt;agent name=&quot;Chat&quot;&gt;&lt;/agent&gt;</span></span><br><span class="line"><span class="string">  &lt;/agents&gt;</span></span><br><span class="line"><span class="string">&lt;/root&gt;`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PLAN_EXAMPLE_LIST</span> = [</span><br><span class="line">  <span class="string">`User: Open Boss Zhipin, find 10 operation positions in Chengdu, and send a personal introduction to the recruiters based on the page information.</span></span><br><span class="line"><span class="string">Output result:</span></span><br><span class="line"><span class="string">&lt;root&gt;</span></span><br><span class="line"><span class="string">  &lt;name&gt;Submit resume&lt;/name&gt;</span></span><br><span class="line"><span class="string">  &lt;thought&gt;OK, now the user requests me to create a workflow that involves opening the Boss Zhipin website, finding 10 operation positions in Chengdu, and sending personal resumes to the recruiters based on the job information.&lt;/thought&gt;</span></span><br><span class="line"><span class="string">  &lt;agents&gt;</span></span><br><span class="line"><span class="string">    &lt;agent name=&quot;Browser&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;task&gt;Open Boss Zhipin, find 10 operation positions in Chengdu, and send a personal introduction to the recruiters based on the page information.&lt;/task&gt;</span></span><br><span class="line"><span class="string">      &lt;nodes&gt;</span></span><br><span class="line"><span class="string">        &lt;node&gt;Open Boss Zhipin, enter the job search page&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;node&gt;Set the regional filter to Chengdu and search for operational positions.&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;node&gt;Brows the job list and filter out 10 suitable operation positions.&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;forEach items=&quot;list&quot;&gt;</span></span><br><span class="line"><span class="string">          &lt;node&gt;Analyze job requirements&lt;/node&gt;</span></span><br><span class="line"><span class="string">          &lt;node&gt;Send a self-introduction to the recruiter&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;/forEach&gt;</span></span><br><span class="line"><span class="string">      &lt;/nodes&gt;</span></span><br><span class="line"><span class="string">    &lt;/agent&gt;</span></span><br><span class="line"><span class="string">  &lt;/agents&gt;</span></span><br><span class="line"><span class="string">&lt;/root&gt;`</span>,</span><br><span class="line">  <span class="string">`User: Every morning, help me collect the latest AI news, summarize it, and send it to the &quot;AI Daily Morning Report&quot; group chat on WeChat.</span></span><br><span class="line"><span class="string">Output result:</span></span><br><span class="line"><span class="string">&lt;root&gt;</span></span><br><span class="line"><span class="string">  &lt;name&gt;AI Daily Morning Report&lt;/name&gt;</span></span><br><span class="line"><span class="string">  &lt;thought&gt;OK, the user needs to collect the latest AI news every morning, summarize it, and send it to a WeChat group named &quot;AI Daily Morning Report&quot; This requires automation, including the steps of data collection, processing, and distribution.&lt;/thought&gt;</span></span><br><span class="line"><span class="string">  &lt;agents&gt;</span></span><br><span class="line"><span class="string">    &lt;agent name=&quot;Timer&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;task&gt;Timing: every morning&lt;/task&gt;</span></span><br><span class="line"><span class="string">    &lt;/agent&gt;</span></span><br><span class="line"><span class="string">    &lt;agent name=&quot;Browser&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;task&gt;Search for the latest updates on AI&lt;/task&gt;</span></span><br><span class="line"><span class="string">      &lt;nodes&gt;</span></span><br><span class="line"><span class="string">        &lt;node&gt;Open Google&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;node&gt;Search for the latest updates on AI&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;forEach items=&quot;list&quot;&gt;</span></span><br><span class="line"><span class="string">          &lt;node&gt;View Details&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;/forEach&gt;</span></span><br><span class="line"><span class="string">        &lt;node output=&quot;summaryInfo&quot;&gt;Summarize search information&lt;/node&gt;</span></span><br><span class="line"><span class="string">      &lt;/nodes&gt;</span></span><br><span class="line"><span class="string">    &lt;/agent&gt;</span></span><br><span class="line"><span class="string">    &lt;agent name=&quot;Computer&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;task&gt;Send a message to the WeChat group chat &quot;AI Daily Morning Report&quot;&lt;/task&gt;</span></span><br><span class="line"><span class="string">      &lt;nodes&gt;</span></span><br><span class="line"><span class="string">        &lt;node&gt;Open WeChat&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;node&gt;Search for the &quot;AI Daily Morning Report&quot; chat group&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;node input=&quot;summaryInfo&quot;&gt;Send summary message&lt;/node&gt;</span></span><br><span class="line"><span class="string">      &lt;/nodes&gt;</span></span><br><span class="line"><span class="string">    &lt;/agent&gt;</span></span><br><span class="line"><span class="string">  &lt;/agents&gt;</span></span><br><span class="line"><span class="string">&lt;/root&gt;`</span>,</span><br><span class="line">  <span class="string">`User: Access the Google team&#x27;s organization page on GitHub, extract all developer accounts from the team, and compile statistics on the countries and regions where these developers are located.</span></span><br><span class="line"><span class="string">Output result:</span></span><br><span class="line"><span class="string">&lt;root&gt;</span></span><br><span class="line"><span class="string">  &lt;name&gt;Statistics of Google Team Developers&#x27; Geographic Distribution&lt;/name&gt;</span></span><br><span class="line"><span class="string">  &lt;thought&gt;Okay, I need to first visit GitHub, then find Google&#x27;s organization page on GitHub, extract the team member list, and individually visit each developer&#x27;s homepage to obtain location information for each developer. This requires using a browser to complete all operations.&lt;/thought&gt;</span></span><br><span class="line"><span class="string">  &lt;agents&gt;</span></span><br><span class="line"><span class="string">    &lt;agent name=&quot;Browser&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;task&gt;Visit Google GitHub Organization Page and Analyze Developer Geographic Distribution&lt;/task&gt;</span></span><br><span class="line"><span class="string">      &lt;nodes&gt;</span></span><br><span class="line"><span class="string">        &lt;node&gt;Visit https://github.com/google&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;node&gt;Click &quot;People&quot; tab to view team members&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;node&gt;Scroll the page to load all developer information&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;node output=&quot;developers&quot;&gt;Extract all developer account information&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;forEach items=&quot;developers&quot;&gt;</span></span><br><span class="line"><span class="string">          &lt;node&gt;Visit developer&#x27;s homepage&lt;/node&gt;</span></span><br><span class="line"><span class="string">          &lt;node&gt;Extract developer&#x27;s location information&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;/forEach&gt;</span></span><br><span class="line"><span class="string">        &lt;node&gt;Compile and analyze the geographic distribution data of all developers&lt;/node&gt;</span></span><br><span class="line"><span class="string">      &lt;/nodes&gt;</span></span><br><span class="line"><span class="string">    &lt;/agent&gt;</span></span><br><span class="line"><span class="string">  &lt;/agents&gt;</span></span><br><span class="line"><span class="string">&lt;/root&gt;`</span>,</span><br><span class="line">  <span class="string">`User: Open Discord to monitor messages in Group A, and automatically reply when new messages are received.</span></span><br><span class="line"><span class="string">Output result:</span></span><br><span class="line"><span class="string">&lt;root&gt;</span></span><br><span class="line"><span class="string">  &lt;name&gt;Automatic reply to Discord messages&lt;/name&gt;</span></span><br><span class="line"><span class="string">  &lt;thought&gt;OK, monitor the chat messages in Discord group A and automatically reply.&lt;/thought&gt;</span></span><br><span class="line"><span class="string">  &lt;agents&gt;</span></span><br><span class="line"><span class="string">    &lt;agent name=&quot;Browser&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;task&gt;Open Group A in Discord&lt;/task&gt;</span></span><br><span class="line"><span class="string">      &lt;nodes&gt;</span></span><br><span class="line"><span class="string">        &lt;node&gt;Open Discord page&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;node&gt;Find and open Group A&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;watch event=&quot;dom&quot; loop=&quot;true&quot;&gt;</span></span><br><span class="line"><span class="string">          &lt;description&gt;Monitor new messages in group chat&lt;/description&gt;</span></span><br><span class="line"><span class="string">          &lt;trigger&gt;</span></span><br><span class="line"><span class="string">            &lt;node&gt;Analyze message content&lt;/node&gt;</span></span><br><span class="line"><span class="string">            &lt;node&gt;Automatic reply to new messages&lt;/node&gt;</span></span><br><span class="line"><span class="string">          &lt;/trigger&gt;</span></span><br><span class="line"><span class="string">        &lt;/watch&gt;</span></span><br><span class="line"><span class="string">      &lt;/nodes&gt;</span></span><br><span class="line"><span class="string">    &lt;/agent&gt;</span></span><br><span class="line"><span class="string">  &lt;/agents&gt;</span></span><br><span class="line"><span class="string">&lt;/root&gt;`</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PLAN_USER_TEMPLATE</span> = <span class="string">`</span></span><br><span class="line"><span class="string">User Platform: &#123;platform&#125;</span></span><br><span class="line"><span class="string">Task Description: &#123;taskPrompt&#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PLAN_USER_TASK_WEBSITE_TEMPLATE</span> = <span class="string">`</span></span><br><span class="line"><span class="string">User Platform: &#123;platform&#125;</span></span><br><span class="line"><span class="string">Task Website: &#123;task_website&#125;</span></span><br><span class="line"><span class="string">Task Description: &#123;taskPrompt&#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getPlanSystemPrompt</span>(<span class="params"><span class="attr">agents</span>: <span class="title class_">Agent</span>[]</span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> agents_prompt = agents</span><br><span class="line">    .<span class="title function_">map</span>(<span class="function">(<span class="params">agent</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        <span class="string">`&lt;agent name=&quot;<span class="subst">$&#123;agent.Name&#125;</span>&quot;&gt;\n`</span> +</span><br><span class="line">        <span class="string">`Description: <span class="subst">$&#123;agent.PlanDescription || agent.Description&#125;</span>\nTools:\n`</span> +</span><br><span class="line">        agent.<span class="property">Tools</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">tool</span>) =&gt;</span> !tool.<span class="property">noPlan</span>)</span><br><span class="line">          .<span class="title function_">map</span>(</span><br><span class="line">            <span class="function">(<span class="params">tool</span>) =&gt;</span></span><br><span class="line">              <span class="string">`- <span class="subst">$&#123;tool.name&#125;</span>: <span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">                tool.planDescription || tool.description || <span class="string">&quot;&quot;</span></span></span></span><br><span class="line"><span class="subst"><span class="string">              &#125;</span>`</span></span><br><span class="line">          )</span><br><span class="line">          .<span class="title function_">join</span>(<span class="string">&quot;\n&quot;</span>) +</span><br><span class="line">        <span class="string">`\n&lt;/agent&gt;`</span></span><br><span class="line">      );</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">join</span>(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">  <span class="keyword">let</span> example_prompt = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">let</span> hasChatAgent = agents.<span class="title function_">filter</span>(<span class="function">(<span class="params">a</span>) =&gt;</span> a.<span class="property">Name</span> == chat_agent_name).<span class="property">length</span> &gt; <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">const</span> example_list = hasChatAgent</span><br><span class="line">    ? [<span class="variable constant_">PLAN_CHAT_EXAMPLE</span>, ...<span class="variable constant_">PLAN_EXAMPLE_LIST</span>]</span><br><span class="line">    : [...<span class="variable constant_">PLAN_EXAMPLE_LIST</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; example_list.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    example_prompt += <span class="string">`## Example <span class="subst">$&#123;i + <span class="number">1</span>&#125;</span>\n<span class="subst">$&#123;example_list[i]&#125;</span>\n\n`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable constant_">PLAN_SYSTEM_TEMPLATE</span>.<span class="title function_">replace</span>(<span class="string">&quot;&#123;name&#125;&quot;</span>, config.<span class="property">name</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="string">&quot;&#123;agents&#125;&quot;</span>, agents_prompt)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="string">&quot;&#123;datetime&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>())</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="string">&quot;&#123;example_prompt&#125;&quot;</span>, example_prompt)</span><br><span class="line">    .<span class="title function_">trim</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getPlanUserPrompt</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">taskPrompt</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  task_website?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (task_website) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable constant_">PLAN_USER_TASK_WEBSITE_TEMPLATE</span>.<span class="title function_">replace</span>(<span class="string">&quot;&#123;taskPrompt&#125;&quot;</span>, taskPrompt)</span><br><span class="line">      .<span class="title function_">replace</span>(<span class="string">&quot;&#123;platform&#125;&quot;</span>, config.<span class="property">platform</span>)</span><br><span class="line">      .<span class="title function_">replace</span>(<span class="string">&quot;&#123;task_website&#125;&quot;</span>, task_website)</span><br><span class="line">      .<span class="title function_">trim</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable constant_">PLAN_USER_TEMPLATE</span>.<span class="title function_">replace</span>(<span class="string">&quot;&#123;taskPrompt&#125;&quot;</span>, taskPrompt)</span><br><span class="line">      .<span class="title function_">replace</span>(<span class="string">&quot;&#123;platform&#125;&quot;</span>, config.<span class="property">platform</span>)</span><br><span class="line">      .<span class="title function_">trim</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>各节点的 prompt：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Agent</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../agent&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">&quot;../config&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Context</span> <span class="keyword">from</span> <span class="string">&quot;../core/context&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; sub &#125; <span class="keyword">from</span> <span class="string">&quot;../common/utils&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">WorkflowAgent</span>, <span class="title class_">Tool</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../types&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; buildAgentRootXml &#125; <span class="keyword">from</span> <span class="string">&quot;../common/xml&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">TOOL_NAME</span> <span class="keyword">as</span> foreach_task &#125; <span class="keyword">from</span> <span class="string">&quot;../tools/foreach_task&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">TOOL_NAME</span> <span class="keyword">as</span> watch_trigger &#125; <span class="keyword">from</span> <span class="string">&quot;../tools/watch_trigger&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">TOOL_NAME</span> <span class="keyword">as</span> human_interact &#125; <span class="keyword">from</span> <span class="string">&quot;../tools/human_interact&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">TOOL_NAME</span> <span class="keyword">as</span> variable_storage &#125; <span class="keyword">from</span> <span class="string">&quot;../tools/variable_storage&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">TOOL_NAME</span> <span class="keyword">as</span> task_node_status &#125; <span class="keyword">from</span> <span class="string">&quot;../tools/task_node_status&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">AGENT_SYSTEM_TEMPLATE</span> = <span class="string">`</span></span><br><span class="line"><span class="string">You are &#123;name&#125;, an autonomous AI agent for &#123;agent&#125; agent.</span></span><br><span class="line"><span class="string">UTC datetime: &#123;datetime&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Task Description</span></span><br><span class="line"><span class="string">&#123;description&#125;</span></span><br><span class="line"><span class="string">&#123;prompt&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># User input task instructions</span></span><br><span class="line"><span class="string">&lt;root&gt;</span></span><br><span class="line"><span class="string">  &lt;!-- Main task, completed through the collaboration of multiple Agents --&gt;</span></span><br><span class="line"><span class="string">  &lt;mainTask&gt;main task&lt;/mainTask&gt;</span></span><br><span class="line"><span class="string">  &lt;!-- The tasks that the current agent needs to complete, the current agent only needs to complete the currentTask --&gt;</span></span><br><span class="line"><span class="string">  &lt;currentTask&gt;specific task&lt;/currentTask&gt;</span></span><br><span class="line"><span class="string">  &lt;!-- Complete the corresponding step nodes of the task --&gt;</span></span><br><span class="line"><span class="string">  &lt;nodes&gt;</span></span><br><span class="line"><span class="string">    &lt;!-- node supports input/output variables to pass dependencies --&gt;</span></span><br><span class="line"><span class="string">    &lt;node input=&quot;variable name&quot; output=&quot;variable name&quot; status=&quot;todo / done&quot;&gt;task step node&lt;/node&gt;&#123;nodePrompt&#125;</span></span><br><span class="line"><span class="string">  &lt;/nodes&gt;</span></span><br><span class="line"><span class="string">&lt;/root&gt;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">HUMAN_PROMPT</span> = <span class="string">`</span></span><br><span class="line"><span class="string">* HUMAN INTERACT</span></span><br><span class="line"><span class="string">During the task execution process, you can use the \`<span class="subst">$&#123;human_interact&#125;</span>\` tool to interact with humans, please call it in the following situations:</span></span><br><span class="line"><span class="string">- When performing dangerous operations such as deleting files, confirmation from humans is required</span></span><br><span class="line"><span class="string">- When encountering obstacles while accessing websites, such as requiring user login, you need to request human assistance</span></span><br><span class="line"><span class="string">- When requesting login, please only call the function when a login dialog box is clearly displayed.</span></span><br><span class="line"><span class="string">- Try not to use the \`<span class="subst">$&#123;human_interact&#125;</span>\` tool</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">VARIABLE_PROMPT</span> = <span class="string">`</span></span><br><span class="line"><span class="string">* VARIABLE STORAGE</span></span><br><span class="line"><span class="string">If you need to read and write the input/output variables in the node, require the use of the \`<span class="subst">$&#123;variable_storage&#125;</span>\` tool.</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FOR_EACH_NODE</span> = <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;!-- duplicate task node, items support list and variable --&gt;</span></span><br><span class="line"><span class="string">    &lt;forEach items=&quot;list or variable name&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;node&gt;forEach item step node&lt;/node&gt;</span></span><br><span class="line"><span class="string">    &lt;/forEach&gt;`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FOR_EACH_PROMPT</span> = <span class="string">`</span></span><br><span class="line"><span class="string">* forEach node</span></span><br><span class="line"><span class="string">repetitive tasks, when executing to the forEach node, require the use of the \`<span class="subst">$&#123;foreach_task&#125;</span>\` tool.</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">WATCH_NODE</span> = <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;!-- monitor task node, the loop attribute specifies whether to listen in a loop or listen once --&gt;</span></span><br><span class="line"><span class="string">    &lt;watch event=&quot;dom or file&quot; loop=&quot;true&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;description&gt;Monitor task description&lt;/description&gt;</span></span><br><span class="line"><span class="string">      &lt;trigger&gt;</span></span><br><span class="line"><span class="string">        &lt;node&gt;Trigger step node&lt;/node&gt;</span></span><br><span class="line"><span class="string">        &lt;node&gt;...&lt;/node&gt;</span></span><br><span class="line"><span class="string">      &lt;/trigger&gt;</span></span><br><span class="line"><span class="string">    &lt;/watch&gt;`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">WATCH_PROMPT</span> = <span class="string">`</span></span><br><span class="line"><span class="string">* watch node</span></span><br><span class="line"><span class="string">monitor changes in webpage DOM or file content, when executing to the watch node, require the use of the \`<span class="subst">$&#123;watch_trigger&#125;</span>\` tool.</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAgentSystemPrompt</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">agent</span>: <span class="title class_">Agent</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">agentNode</span>: <span class="title class_">WorkflowAgent</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">context</span>: <span class="title class_">Context</span>,</span></span><br><span class="line"><span class="params">  tools?: <span class="title class_">Tool</span>[],</span></span><br><span class="line"><span class="params">  extSysPrompt?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> prompt = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">let</span> nodePrompt = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  tools = tools || agent.<span class="property">Tools</span>;</span><br><span class="line">  <span class="keyword">let</span> agentNodeXml = agentNode.<span class="property">xml</span>;</span><br><span class="line">  <span class="keyword">let</span> hasWatchNode = agentNodeXml.<span class="title function_">indexOf</span>(<span class="string">&quot;&lt;/watch&gt;&quot;</span>) &gt; -<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">let</span> hasForEachNode = agentNodeXml.<span class="title function_">indexOf</span>(<span class="string">&quot;&lt;/forEach&gt;&quot;</span>) &gt; -<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">let</span> hasHumanTool = tools.<span class="title function_">filter</span>(<span class="function">(<span class="params">tool</span>) =&gt;</span> tool.<span class="property">name</span> == human_interact).<span class="property">length</span> &gt; <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> hasVariable =</span><br><span class="line">    agentNodeXml.<span class="title function_">indexOf</span>(<span class="string">&quot;input=&quot;</span>) &gt; -<span class="number">1</span> ||</span><br><span class="line">    agentNodeXml.<span class="title function_">indexOf</span>(<span class="string">&quot;output=&quot;</span>) &gt; -<span class="number">1</span> ||</span><br><span class="line">    tools.<span class="title function_">filter</span>(<span class="function">(<span class="params">tool</span>) =&gt;</span> tool.<span class="property">name</span> == variable_storage).<span class="property">length</span> &gt; <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (hasHumanTool) &#123;</span><br><span class="line">    prompt += <span class="variable constant_">HUMAN_PROMPT</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (hasVariable) &#123;</span><br><span class="line">    prompt += <span class="variable constant_">VARIABLE_PROMPT</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (hasForEachNode) &#123;</span><br><span class="line">    <span class="keyword">if</span> (tools.<span class="title function_">filter</span>(<span class="function">(<span class="params">tool</span>) =&gt;</span> tool.<span class="property">name</span> == foreach_task).<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      prompt += <span class="variable constant_">FOR_EACH_PROMPT</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    nodePrompt += <span class="variable constant_">FOR_EACH_NODE</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (hasWatchNode) &#123;</span><br><span class="line">    <span class="keyword">if</span> (tools.<span class="title function_">filter</span>(<span class="function">(<span class="params">tool</span>) =&gt;</span> tool.<span class="property">name</span> == watch_trigger).<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      prompt += <span class="variable constant_">WATCH_PROMPT</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    nodePrompt += <span class="variable constant_">WATCH_NODE</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (extSysPrompt &amp;&amp; extSysPrompt.<span class="title function_">trim</span>()) &#123;</span><br><span class="line">    prompt += <span class="string">&quot;\n&quot;</span> + extSysPrompt.<span class="title function_">trim</span>() + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (context.<span class="property">chain</span>.<span class="property">agents</span>.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    prompt += <span class="string">&quot;\n Main task: &quot;</span> + context.<span class="property">chain</span>.<span class="property">taskPrompt</span>;</span><br><span class="line">    prompt += <span class="string">&quot;\n# Pre-task execution results&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; context.<span class="property">chain</span>.<span class="property">agents</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">let</span> agentChain = context.<span class="property">chain</span>.<span class="property">agents</span>[i];</span><br><span class="line">      <span class="keyword">if</span> (agentChain.<span class="property">agentResult</span>) &#123;</span><br><span class="line">        prompt += <span class="string">`\n## <span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">          agentChain.agent.task || agentChain.agent.name</span></span></span><br><span class="line"><span class="subst"><span class="string">        &#125;</span>\n<span class="subst">$&#123;sub(agentChain.agentResult, <span class="number">500</span>)&#125;</span>`</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (prompt) &#123;</span><br><span class="line">    prompt = <span class="string">&quot;\n&quot;</span> + prompt.<span class="title function_">trim</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable constant_">AGENT_SYSTEM_TEMPLATE</span>.<span class="title function_">replace</span>(<span class="string">&quot;&#123;name&#125;&quot;</span>, config.<span class="property">name</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="string">&quot;&#123;agent&#125;&quot;</span>, agent.<span class="property">Name</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="string">&quot;&#123;description&#125;&quot;</span>, agent.<span class="property">Description</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="string">&quot;&#123;datetime&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>())</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="string">&quot;&#123;prompt&#125;&quot;</span>, prompt)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="string">&quot;&#123;nodePrompt&#125;&quot;</span>, nodePrompt)</span><br><span class="line">    .<span class="title function_">trim</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAgentUserPrompt</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">agent</span>: <span class="title class_">Agent</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">agentNode</span>: <span class="title class_">WorkflowAgent</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">context</span>: <span class="title class_">Context</span>,</span></span><br><span class="line"><span class="params">  tools?: <span class="title class_">Tool</span>[]</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> hasTaskNodeStatusTool =</span><br><span class="line">    (tools || agent.<span class="property">Tools</span>).<span class="title function_">filter</span>(<span class="function">(<span class="params">tool</span>) =&gt;</span> tool.<span class="property">name</span> == task_node_status)</span><br><span class="line">      .<span class="property">length</span> &gt; <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildAgentRootXml</span>(</span><br><span class="line">    agentNode.<span class="property">xml</span>,</span><br><span class="line">    context.<span class="property">chain</span>.<span class="property">taskPrompt</span>,</span><br><span class="line">    <span class="function">(<span class="params">nodeId, node</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (hasTaskNodeStatusTool) &#123;</span><br><span class="line">        node.<span class="title function_">setAttribute</span>(<span class="string">&quot;status&quot;</span>, <span class="string">&quot;todo&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="其他比较有价值的-PR"><a href="#其他比较有价值的-PR" class="headerlink" title="其他比较有价值的 PR"></a>其他比较有价值的 PR</h2><ol>
<li><a target="_blank" rel="noopener" href="https://github.com/FellouAI/eko/pull/36">#36</a>：增加了 Human Tools，通过 callbacks 实现在工作流执行中和用户交互的方法。在 v0 和 v1 中都是 4 个独立的工具，在 v2 中被整合成一个工具。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/FellouAI/eko/pull/37">#37</a> &amp; <a target="_blank" rel="noopener" href="https://github.com/FellouAI/eko/pull/88">#88</a>：实现了工作流结束时的总结功能，一开始的实现是添加一个额外的工具，并在 prompt 里提示大模型调用；后来撤回了这个修改，改成了工作流结束后将完整执行过程发给单独的 Agent 让它总结。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/FellouAI/eko/pull/132">#132</a>：用云日志托管平台来实现可在线查看的日志，使用 uuidv4 跟踪每个 Workflow 实例的执行过程。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/FellouAI/eko/pull/151">#151</a>：通过一系列方法限制了 token 消耗，包括上下文压缩、限制工具输出长度、限制对话轮数、移除 input schema 补丁的 p2。</li>
</ol>
<h2 id="一些见解"><a href="#一些见解" class="headerlink" title="一些见解"></a>一些见解</h2><ol>
<li>在 ReAct 范式下，上下文是线性增长的。在这个背景下，解决越来越复杂的任务，首先要解决越来越长的上下文。这里的上下文包括：<ol>
<li>system prompt &amp; tools：每个 Agent 都有自己负责的一块 domain，并有与之配对的 system prompt 和 tools。</li>
<li>user prompt：Workflow 的输入，分为用户输入的 prompt 和大模型生成的 prompt。</li>
<li>tool call &amp; results：每次调用工具时的输入和输出。</li>
</ol>
</li>
<li>有很多方法可以解决上下文越来越长的问题：<ol>
<li>上下文压缩：对 tool call &amp; results 做压缩，但是 1) 不能保证不删除关键信息；2) 不能解决 system prompt &amp; tools 随着问题空间变大、答案验证更细致而越来越长的问题。</li>
<li>Multi-Agent：按 domain 拆分 system prompt &amp; tools，进而自动拆分了 user prompt 和 tool call &amp; results。</li>
</ol>
</li>
</ol>

    </div>
    
    <div class="post__license">
        <p>
            <strong>Author: </strong>HairlessVillager
        </p>
        <p>
            <strong>
                Permalink: 
            </strong>
            <a href="http://hairlessvillager.github.io/2025/09/11/eko-work-review/">http://hairlessvillager.github.io/2025/09/11/eko-work-review/</a>
        </p>
        
            <strong>
                <p>The article is licensed under the <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a> protocol by default.</p>

            </strong>
        
            <strong>
                <p>Please comply with the protocol when using it.</p>

            </strong>
        
    </div>
 
    <div class="post-footer__meta"><p>Updated@2025-09-11 17:51</p></div> 
    <div class="post-entry__tags"></div> 
</article>


    <div class="nav">
        <div class="nav__prev">
            
        </div>
        <div class="nav__next">
            
                <a href="/2025/07/09/region-diff/" class="nav__link">
                    <div>
                        <div class="nav__label">
                            Next Post
                        </div>
                        <div class="nav__title">
                            记录 Region Diff 开发中的一些思考
                        </div>
                    </div>
                    <div>
                        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M434.944 790.624l-45.248-45.248L623.04 512l-233.376-233.376 45.248-45.248L713.568 512z" fill="#808080"></path></svg>
                    </div>
                </a>
            
        </div>
    </div>





</main>

            <footer class="footer">
     
    <a href="#" class="button" id="b2t" aria-label="Back to Top" title="Back to Top">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" width="32" height="32">
            <path d="M233.376 722.752L278.624 768 512 534.624 745.376 768l45.248-45.248L512 444.128zM192 352h640V288H192z" fill="currentColor"></path>
        </svg>
    </a>

    


    
     
 

 
    
        
        <p class="footer-copyright">
            Copyright © 2023&nbsp;-&nbsp;2025 <a href="/">HairlessVillager&#39;s Blog</a>
        </p>
    
    
    <p>Powered by <a href="https://hexo.io" target="_blank">Hexo</a> | Theme - <a href="https://github.com/ChrAlpha/hexo-theme-cards" target="_blank">Cards</a></p>
</footer>

        </div>
         

 

 

 

 



 



 


    
 

 

 

 

 

 




    </body>
</html>
